\documentclass[DM,lsstdraft,toc]{lsstdoc}

% lsstdoc documentation: https://lsst-texmf.lsst.io/lsstdoc.html

% Package imports go here.
\usepackage{enumitem}

% Local commands go here.

\newcounter{usecase}
\newcommand{\usecase}[2]{
  \refstepcounter{usecase}
  \subsection{\emph{#1\theusecase}: #2}\label{use:#1\theusecase}
}

\newenvironment{flow}[1][Basic flow]
  {\subsubsection*{#1}\begin{enumerate}[label=\alph*.,itemsep=0pt]}
  {\end{enumerate}}

% To add a short-form title:
% \title[Short title]{Title}
\title{Batch Processing Services}

% Optional subtitle
% \setDocSubtitle{A subtitle}

\author{Mikolaj Kowalik, Michelle Gower, and Rob Kooper}

\setDocRef{LDM-633}

\date{\today}

% Optional: name of the document's curator
% \setDocCurator{The Curator of this Document}

\setDocAbstract{%
  This document describes use cases for Offline Processing Workflow Services.
}

% Change history defined here.
% Order: oldest first.
% Fields: VERSION, DATE, DESCRIPTION, OWNER NAME.
% See LPM-51 for version number policy.
\setDocChangeRecord{%
  \addtohist{1}{YYY-MM-DD}{Unreleased.}{Mikolaj Kowalik}
}

\begin{document}

% Create the title page.
% Table of contents is added automatically with the "toc" class option.
\maketitle

\section{Introduction}

This document describes use cases for the LSST Batch Production Service.  These
use cases are driven by production offline processing, but may also apply to
other user needs, e.g. pipeline developers.

\section{Definitions}

\begin{description}
  \item[Pipeline] 
    An ordered sequence of individual steps.
  \item[Payload]
    A sequence of pipelines that performs particular data analysis and product
    generation.
  \item[Campaign]
    A set of all pipelines executions needed to achieve a LSST objective.
\end{description}

\section{Actors}

\begin{description}
  \item[Operator (OP)]
    A person responsible for offline processing (e.g. DRP).

  \item[Campaign Manager (CM)]
    A system or person managing processing campaigns.

  \item[Worfklow Management System (WMS)]
    A system managing an execution of a pipeline.
\end{description}

\section{Scope of Operations}
An Operator may wish to perform operations, such as submissions, restarts,
pausing, terminating, monitoring, etc., to single pipelines or groups of
pipelines determined by some description, such as campaign, ones currently
running, etc.

\section{Configuration}

\usecase{BPS}{Override default configuration options}
The Operator wants to override a subset of configuration options for a
campaign/pipeline at any configuration level (i.e., global, site, campaign,
pipeline, job, SuperTask). These overrides include but are not limited to:
\begin{itemize}
  \item
    execution configuration of a SuperTask (e.g., expected amount of memory
    needed),
  \item
    science configuration of a SuperTask (e.g., update particular threshold),
  \item
    globally override certain configurations (e.g., whether to bring all output
    datasets home from job including intermediates),
  \item
    specify to process campaign/pipeline/jobs on particular computational
    platform(s),
  \item
    excluding certain data from a campaign,
  \item
    modify pipeline sequence of SuperTasks (e.g., only run half of a pipeline
    for debugging).
\end{itemize}

\usecase{BPS}{Select specific software version(s)}
The Operator requests to run a pipeline with specific versions of the LSST
packages (e.g. wants to use a particular LSST Stack release or specific
versions of individual packages).

\usecase{BPS}{Order steps in a pipeline}
The Operator specifies the order in which steps constituting the pipeline
should be executed (e.g. to postpone execution of steps which are likely to
fail towards the end of a pipeline or start processing from specific steps).

\usecase{BPS}{Divide a pipeline into smaller subpipelines}
The Operator divides a pipeline into smaller subpipelines. (e.g. when the
actual number of outputs generated by the pipeline upstream determines the size
of a subpipeline downstream).

\usecase{BPS}{Group pipelines steps into a pipeline jobs}
The Operator groups subsets of pipeline steps together into smaller number of
compute jobs to reduce the time overhead related to job startup costs.

\usecase{BPS}{Customize a pipeline}
The Operator needs the ability to customize a pipeline for various reasons including:
\begin{itemize}
  \item 
    only need to run the first steps in a larger pipeline to produce outputs
    needed for debugging.
  \item
    run last steps from a larger pipeline starting with outputs of previous
    executions of the larger pipeline.
  \item
    set the order in which steps constituting the pipeline should be executed
    (e.g. to postpone execution of steps which are likely to fail towards the
    end of a pipeline).
\end{itemize}

\section{Execution}

\usecase{BPS}{Initiate a campaign}
The Operator specifies a set of pipelines, their configurations, set of inputs,
an initial priority (either for the entire campaign or for individual
pipelines), and submits them for processing.

\usecase{BPS}{Terminate a failed campaign/pipelines}
The Operator declares a running campaign/pipelines to be a failure and wants to terminate the processing before its completion.

\usecase{BPS}{Pause/Unpause a campaign/pipelines}
The Operator or CM wants to pause dispatching of new compute jobs or pipelines
in a campaign to release the resources, e.g., for a campaign with higher
priority or for maintenance, allowing currently running compute jobs or
pipelines to continue running.  The operator will also need to unpause
campaigns/pipelines that have been put on hold.  This does not include the
ability to change configuration, etc. for the campaign/pipeline.

\usecase{BPS}{Prioritize campaign/pipelines}
The Operator wants to designate different processing priorities for
campaigns/pipelines at time of submission or needs to alter those priorities
for pending pipelines.

\usecase{BPS}{Dispatch campaign/pipeline/jobs to specific platform(s)}
The Operator or the Campaign Manager dispatches campaign/pipeline/jobs to
compute resources where the computational platform(s) may be specified and may
provide a list of specific machine(s) to avoid (e.g., run on cluster at
CC-IN2P3 but avoid specific machines cc3000 and cc4003).

\usecase{BPS}{Execute a campaign on different architectures}
The Operator wants the flexibility to execute pipelines on platforms with
different architectures (e.g. with and without shared filesystem).

\usecase{BPS}{Run a pipeline using Gen3 Middleware}
The Operator wants to run a scientific payload which uses Gen3 Middleware (e.g.
to chain a set of SuperTasks in memory).

\usecase{BPS}{Fail pipelines immediately or lazily}
Under certain conditions, the Operator may want to have the pipeline execution
halt at first failure or continue execution as long as pipeline dependencies
are satisfied. In either case, the Operator wants a pipeline execution to be marked as failed.

\usecase{BPS}{Restart a failed campaign/pipeline}
The Operator requests to start processing a failed pipeline from the point as
close as possible to the failure (i.e. not from the very beginning). Restarting
a pipeline may include one or more of the following: changing software stack to
be used, changing science configuration, changing execution configuration, etc.

\usecase{BPS}{Designate point of failure}
A pipeline execution may not hard fail at the correct step and hard fail later
or may seemly complete the entire pipeline but produce bad science results.  An
Operator may choose to either submit a new pipeline/campaign or wants to
restart pipelines at a failure point the operator chooses.

\usecase{BPS}{Save intermediate datasets}
The Operator wants to be able to turn on/off the saving of intermediate
datasets.

\usecase{BPS}{Support optional inputs}
Certain steps in a pipeline can proceed even when not all declared inputs are
present. The Operator wants to continue with processing for such steps
providing their minimal requirements are satisfied.

\usecase{BPS}{Retry defective steps/jobs}
The Operator requests to automatically retry defective steps/jobs providing
certain criteria are met (e.g. job type, type of failure).  The preference is
to retry the minimal amount necessary, but leaving flexibility to work around
implementation difficulties.

\usecase{BPS}{Deal with unknown/defective data}
The Operator wants to stage out any files that are not expected (i.e. are in a
wrong place, have wrong name) or are missing some of required metadata.

\usecase{BPS}{Investigate output datasets}
The Operator wants to use similar procedures and tools to investigate both
successful and failed campaign/pipelines/jobs.

\usecase{BPS}{Interact with the Data Backbone}
The Operator wants to have an ability to use the inputs for the payloads which
originate from the Data Backbone and store the results there.

\usecase{BPS}{Dispatch and manage pipelines at scale}
The Operator wants to dispatch and manage pipelines at the scale needed to meet
LSST objectives within the objective’s time constraints.

\usecase{BPS}{Spawn a familiar}
The Operator wants a pet to be present during a campaign execution for their
emotional support.

\section{Monitoring}

\usecase{BPS}{Monitor available resources}
The Operator wants to know what is the state of available computational
resources (e.g. are there any unscheduled outages).

\usecase{BPS}{Monitor campaign/pipeline/job/SuperTask execution}
The Operator or the Campaign Manager tracks campaign/pipeline/job execution,
i.e., monitors in real time metrics such as:
\begin{itemize}
  \item
    number of pending, running, finished, and failed jobs/SuperTasks;
  \item
    amount of computer resources (e.g. CPUs, memory, disk space) in use vs
    idle;
  \item
    job runtime information (e.g. hostname, memory, wall/CPU time, data input
    and output volume).
  \item
    what SuperTask or framework step is currently running (if possible seeing
    stdout/stderr from the step) for when pipelines seem to be taking too long.
\end{itemize}

\usecase{BPS}{Verify results integrity}
The Operator wants the ability to configure the system to verify that all the
required outputs were generated and staged out correctly for each successful
pipeline according to the pipeline configuration.

Note: Validation that the pipeline configuration and execution produced the correct results is outside of the scope of this use case.

\usecase{BPS}{Notify about events}
The Operator may want to be notified about pipeline/campaign level events (e.g.
its failure, completion, jobs taking longer than some operator-specified
threshold, etc.)

\section{History}

\usecase{BPS}{View runtime metrics and provenance}
For each step (including SuperTasks, scheduling, data transfer, database
access, pre-flight, etc.), the Operator wants to view/query information such
as:
\begin{itemize}
  \item
    when it was running and time it took for the process to complete,
  \item
    amount of memory it used during its execution,
  \item
    machine where it was executed,
  \item
    version of software used,
  \item
    what input datasets were used (where applicable),
  \item
    what output datasets were produced (where applicable).
\end{itemize}

\usecase{BPS}{View data quality metrics}
For each campaign/pipeline, the Operator wants to view any metrics measuring
data quality output by the pipeline.

\usecase{BPS}{Browse stdout/stderr/logs}
The Operator wants to have easy access to stderr/stdout/logs finished jobs,
i.e., being able to quickly find the log file of a specific job, search log
files for certain keywords/phrases.

\usecase{BPS}{Compare pipeline executions}
The Operator wants to compare different pipeline executions with regard to data
products, quality control and runtime metrics (e.g. to evaluate the impact of a
software change).

\usecase{BPS}{Summarize a campaign}
The Operator wants to see a summary of a campaign, e.g., a breakdown showing
times, resource usage for individual pipelines (if possible, indicating
pipelines deviating from a norm).

% Include all the relevant bib files.
% https://lsst-texmf.lsst.io/lsstdoc.html#bibliographies
%\bibliography{lsst,lsst-dm,refs_ads,refs,books}

\end{document}
# vim: ts=2 sw=2 et
